{% extends "layout.html" %}
{% block title %}用户故事{% endblock %}
{% block content %}
  <h1>用户故事</h1>

  <div>
    <ul class="uk-list uk-list-line">
      {# project header #}
      <div class="uk-grid">
        <div class="uk-width-1-10"><strong>项目编号</strong></div>
        <div class="uk-width-1-10"><strong>项目类别</strong></div>
        <div class="uk-width-4-10"><strong>项目名称</strong></div>
      </div>

      {% for p in data.project %}
        <li class="project-row">
          {# project row #}
          <div class="uk-grid">
            <div class="uk-width-1-10">
              <a href="" class="uk-icon-tasks"></a>
              {{p.id}}
            </div>
            <div class="uk-width-1-10">{{p.category}}</div>
            <div class="uk-width-4-10">{{p.name}}</div>
          </div>

          {# userstory list #}
          <ul class="uk-list uk-list-striped">
            {% for u in data.userstory %}
            {% if u.project_id==p.id %}
            <li class="us-row" project="{{p.id}}" usid="{{u.id}}">
              <div class="uk-grid">
                <div class="uk-width-5-10">{{u.name}}</div>
                <div class="uk-width-1-10">{{u.status}}</div>
                <div class="uk-width-1-10">{{u.priority}}</div>
                <div class="uk-width-2-10">
                  <a href="#" onclick="userstory_delete(this);">删除</a>
                  <a href="#" onclick="userstory_edit(this);">编辑</a>
                  <a href="#" onclick="userstory_insert(this);">插入</a>
                </div>
              </div>
            </li>
            {% endif %}
            {% endfor %}


          </ul>



        </li>
      {% endfor %}


      {# 整个页面只有一个edit面板，当哪里需要的时候就搬迁过去并适当初始化 #}
      <li id="us-edit-panel" class="uk-hidden">
        <div class="uk-grid data-uk-grid-match">
          <input id="project_id" class="us-input uk-hidden" value="" />
          <div class="uk-width-5-10">
            <textarea id="name" class="us-input" rows="" cols=""></textarea>
          </div>
          <div class="uk-width-1-10">
            <select id="status" class="us-input"><option>正常</option><option>挂起</option><option>取消</option></select>
          </div>
          <div class="uk-width-1-10 uk-form-controls">
            <select id="priority" class="us-input"><option>低</option><option>一般</option><option>高</option><option>紧急</option></select>
          </div>
          <div class="uk-width-2-10">
            <a href="#" onclick="userstory_insert_save(this);">保存</a>
          </div>
        </div>
      </li>
    </ul>
  </div>

<script type="text/javascript">
function userstory_insert(element){
  //init data
  var target_us_row = $(element).closest("li.us-row");
  var us_editor = $('li#us-edit-panel');
  var project_id = $(target_us_row).attr("project");
  $(us_editor).find("#project_id.us-input").attr("value", project_id);
  //move us editor to right position
  $(us_editor).detach();
  $(us_editor).insertAfter($(target_us_row));
  $(us_editor).removeClass("uk-hidden");
}

function userstory_edit(element){
  var name = $(element).text();
  alert(name);
}

/*删除特定的用户故事*/
function userstory_delete(element){
  var usid = $(element).closest("li.us-row").attr("usid");
  
  //ajax to delete selected us
  $.ajax({
    url: "{{url_for('ajax_delete_us')}}",
    type: 'POST',
    dataType: 'json',
    data: {"usid": usid},
    async: false,
    cache: false,
    success: function(result) {
      if(result.code==0){
        //alert('提交成功,rowid=' + result.rowid);
        window.location.href="{{url_for('list_userstory')}}";
      }else{
        alert('提交失败,error="' + result.message + '"');
      }
    }
  });
}

/* Save the new added us by AJAX */
function userstory_insert_save(element){
  //get inputed fields
  var name = $('#name.us-input').val();
  var status = $('#status.us-input').val();
  var priority = $('#priority.us-input').val();
  var project_id = $('#project_id.us-input').attr('value');

  //check if input is valid
  if(name.length==0){
    alert("Name cant't be empty!");
    return;
  }
  var data = {'name': name,
              'status': status,
              'priority': priority,
              'project_id': project_id};
  console.info(data);

  //ajax to save new us
  $.ajax({
    url: "{{url_for('ajax_add_new_us')}}",
    type: 'POST',
    dataType: 'json',
    data: data,
    async: false,
    cache: false,
    success: function(result) {
      if(result.code==0){
        //alert('提交成功,rowid=' + result.rowid);
        window.location.href="{{url_for('list_userstory')}}";
      }else{
        alert('提交失败,error="' + result.message + '"');
      }
    }
  });
}
</script>

{% endblock %}
